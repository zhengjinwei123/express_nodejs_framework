/**
 * Created by zhengjinwei on 2015/12/29.
 */

var path = require("path");
var fs = require("fs");

function fileLoader(opts) {
    var configFilesDirList = opts.config_files_dir;
    this.opts = opts;

    if (configFilesDirList.length) {
        var contexts = [];
        for (var i = 0; i < configFilesDirList.length; i++) {
            var dirName = configFilesDirList[i].dir;
            var _path = path.join(opts.basedir, "/", dirName, "/context.json");

            contexts.push(require.resolve(_path));

            var dir = require(_path).scan;
            var localPath = path.join(opts.basedir, "/", dirName, "/", dir);
            var dirList = fs.readdirSync(localPath);
            var _components = {};
            dirList.forEach(function (fileName) {
                var filePath = localPath + "/" + fileName;
                var module = require(filePath);

                _components[module.id] = filePath;
            });


            this.componets = _components;
        }


        contexts.push(require.resolve("../context.json"));//application

        opts.bearCat.createApp(contexts, {BEARCAT_HOT: "on", BEARCAT_HPATH: []});
    }
}

fileLoader.prototype.run = function (cb) {
    var thatComponents = this.componets;
    var bearCat = this.opts.bearCat;
    this.opts.bearCat.start(function () {
        var application = bearCat.getBean('application');
        application.init(bearCat,thatComponents);
        cb(true);
    });
};


module.exports = fileLoader;